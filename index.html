<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CGP Resume Converter</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #CC3300;
            --primary-dark: #A32900;
            --secondary: #1a1a2e;
            --accent: #E8E8E8;
            --bg: #FAFAFA;
            --card-bg: #FFFFFF;
            --text: #1a1a2e;
            --text-muted: #6B7280;
            --success: #10B981;
            --border: #E5E7EB;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--secondary) 0%, #2d2d4a 100%);
            padding: 1.5rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 45px;
            height: 45px;
            background: var(--primary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            font-size: 1.2rem;
            transform: rotate(-3deg);
        }

        .logo-text {
            color: white;
            font-size: 1.4rem;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .logo-text span {
            color: var(--primary);
        }

        .header-subtitle {
            color: rgba(255,255,255,0.7);
            font-size: 0.85rem;
            font-family: 'Space Mono', monospace;
        }

        /* Main Container */
        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 2.5rem 1.5rem;
        }

        /* Steps Indicator */
        .steps {
            display: flex;
            justify-content: center;
            gap: 0;
            margin-bottom: 2.5rem;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0.75rem 1.5rem;
            background: var(--card-bg);
            border: 2px solid var(--border);
            position: relative;
            transition: all 0.3s ease;
        }

        .step:first-child {
            border-radius: 50px 0 0 50px;
        }

        .step:last-child {
            border-radius: 0 50px 50px 0;
        }

        .step.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .step.completed {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .step-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .step.active .step-number,
        .step.completed .step-number {
            background: rgba(255,255,255,0.25);
        }

        .step-label {
            font-weight: 500;
            font-size: 0.9rem;
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 25px rgba(0,0,0,0.06);
            border: 1px solid var(--border);
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1.25rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #f8f9fa 0%, #fff 100%);
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: linear-gradient(135deg, #fff5f2 0%, #fff 100%);
        }

        .upload-area.drag-over {
            border-color: var(--primary);
            background: #fff5f2;
            transform: scale(1.01);
        }

        .upload-area.has-file {
            border-color: var(--success);
            background: linear-gradient(135deg, #ecfdf5 0%, #fff 100%);
        }

        .upload-icon {
            width: 70px;
            height: 70px;
            margin: 0 auto 1.25rem;
            background: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            transition: all 0.3s ease;
        }

        .upload-area:hover .upload-icon {
            background: var(--primary);
            color: white;
            transform: scale(1.05);
        }

        .upload-area.has-file .upload-icon {
            background: var(--success);
            color: white;
        }

        .upload-text {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .upload-subtext {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .file-name {
            margin-top: 1rem;
            padding: 0.75rem 1.25rem;
            background: var(--accent);
            border-radius: 8px;
            font-family: 'Space Mono', monospace;
            font-size: 0.85rem;
            display: inline-block;
        }

        /* Form Grid */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.25rem;
        }

        @media (max-width: 600px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text);
        }

        input, select {
            padding: 0.85rem 1rem;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            font-family: 'DM Sans', sans-serif;
            transition: all 0.2s ease;
            background: white;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(204, 51, 0, 0.1);
        }

        /* Buttons */
        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            font-family: 'DM Sans', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(204, 51, 0, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(204, 51, 0, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--accent);
            color: var(--text);
        }

        .btn-secondary:hover {
            background: #d1d5db;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(16, 185, 129, 0.4);
        }

        .actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        /* Loading */
        .loading {
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 3rem;
        }

        .loading.active {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--accent);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 1.25rem;
            font-weight: 500;
            color: var(--text-muted);
        }

        /* Preview Section */
        .preview-section {
            display: none;
        }

        .preview-section.active {
            display: block;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .preview-content {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1.5rem;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'Space Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.8;
            border: 1px solid var(--border);
        }

        .preview-content h3 {
            color: var(--primary);
            margin: 1rem 0 0.5rem;
            font-family: 'DM Sans', sans-serif;
        }

        .preview-content h3:first-child {
            margin-top: 0;
        }

        /* Success Message */
        .success-message {
            display: none;
            text-align: center;
            padding: 3rem;
        }

        .success-message.active {
            display: block;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 2.5rem;
            color: white;
            animation: pop 0.5s ease;
        }

        @keyframes pop {
            0% { transform: scale(0); }
            70% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .success-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .success-subtitle {
            color: var(--text-muted);
            margin-bottom: 2rem;
        }

        /* Error */
        .error-message {
            background: #FEE2E2;
            border: 1px solid #FECACA;
            color: #DC2626;
            padding: 1rem 1.25rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            display: none;
        }

        .error-message.active {
            display: block;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        /* Hide sections */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .steps {
                flex-direction: column;
                align-items: center;
            }

            .step {
                width: 100%;
                max-width: 280px;
                border-radius: 10px !important;
                justify-content: center;
            }

            .container {
                padding: 1.5rem 1rem;
            }

            .actions {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <div class="logo-icon">CGP</div>
            <div>
                <div class="logo-text">Resume <span>Converter</span></div>
                <div class="header-subtitle">Powered by AI</div>
            </div>
        </div>
    </header>

    <main class="container">
        <!-- Steps Indicator -->
        <div class="steps">
            <div class="step active" id="step1-indicator">
                <div class="step-number">1</div>
                <div class="step-label">Upload Resume</div>
            </div>
            <div class="step" id="step2-indicator">
                <div class="step-number">2</div>
                <div class="step-label">Enter Details</div>
            </div>
            <div class="step" id="step3-indicator">
                <div class="step-number">3</div>
                <div class="step-label">Download</div>
            </div>
        </div>

        <!-- Error Message -->
        <div class="error-message" id="error-message"></div>

        <!-- Step 1: Upload -->
        <section class="section active" id="step1">
            <div class="card">
                <div class="card-title">
                    <div class="card-title-icon">üìÑ</div>
                    Upload Candidate Resume
                </div>
                <div class="upload-area" id="upload-area">
                    <div class="upload-icon">üìÅ</div>
                    <div class="upload-text">Drop your resume here or click to browse</div>
                    <div class="upload-subtext">Supports PDF files (Max 10MB)</div>
                    <div class="file-name" id="file-name" style="display: none;"></div>
                </div>
                <input type="file" id="file-input" accept=".pdf" style="display: none;">
            </div>

            <div class="actions">
                <button class="btn btn-primary" id="next-to-step2" disabled>
                    Continue to Details ‚Üí
                </button>
            </div>
        </section>

        <!-- Step 2: Candidate Details -->
        <section class="section" id="step2">
            <div class="card">
                <div class="card-title">
                    <div class="card-title-icon">üë§</div>
                    Candidate Details
                </div>
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="candidate-name">Candidate Name *</label>
                        <input type="text" id="candidate-name" placeholder="e.g. John Tan Wei Ming" required>
                    </div>
                    <div class="form-group">
                        <label for="nationality">Nationality *</label>
                        <select id="nationality" required>
                            <option value="">Select nationality</option>
                            <option value="Singaporean">Singaporean</option>
                            <option value="Singapore PR">Singapore PR</option>
                            <option value="Malaysian">Malaysian</option>
                            <option value="Chinese">Chinese</option>
                            <option value="Indian">Indian</option>
                            <option value="Filipino">Filipino</option>
                            <option value="Indonesian">Indonesian</option>
                            <option value="Vietnamese">Vietnamese</option>
                            <option value="Thai">Thai</option>
                            <option value="Myanmar">Myanmar</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="gender">Gender *</label>
                        <select id="gender" required>
                            <option value="">Select gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="expected-salary">Expected Salary (SGD) *</label>
                        <input type="text" id="expected-salary" placeholder="e.g. $4,000 or $4,000 - $5,000">
                    </div>
                    <div class="form-group">
                        <label for="notice-period">Notice Period *</label>
                        <select id="notice-period" required>
                            <option value="">Select notice period</option>
                            <option value="Immediate">Immediate</option>
                            <option value="1 Week">1 Week</option>
                            <option value="2 Weeks">2 Weeks</option>
                            <option value="1 Month">1 Month</option>
                            <option value="2 Months">2 Months</option>
                            <option value="3 Months">3 Months</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="actions">
                <button class="btn btn-secondary" id="back-to-step1">‚Üê Back</button>
                <button class="btn btn-primary" id="generate-btn">
                    üöÄ Generate CGP Resume
                </button>
            </div>
        </section>

        <!-- Loading -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div class="loading-text" id="loading-text">Processing resume with AI...</div>
        </div>

        <!-- Step 3: Preview & Download -->
        <section class="section" id="step3">
            <div class="success-message active">
                <div class="success-icon">‚úì</div>
                <div class="success-title">Resume Converted Successfully!</div>
                <div class="success-subtitle">Your CGP-formatted resume is ready to download</div>
            </div>

            <div class="card preview-section active">
                <div class="preview-header">
                    <div class="card-title" style="margin-bottom: 0;">
                        <div class="card-title-icon">üëÅÔ∏è</div>
                        Preview
                    </div>
                </div>
                <div class="preview-content" id="preview-content">
                    <!-- Preview will be inserted here -->
                </div>
            </div>

            <div class="actions">
                <button class="btn btn-secondary" id="start-over">‚Üê Convert Another</button>
                <button class="btn btn-success" id="download-btn">
                    üì• Download .docx
                </button>
            </div>
        </section>
    </main>

    <footer class="footer">
        <p>CGP Resume Converter ‚Ä¢ Cornerstone Global Partners Pte Ltd</p>
    </footer>

    <script>
        // PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // State
        let uploadedFile = null;
        let extractedText = '';
        let parsedResume = null;

        // DOM Elements
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const fileName = document.getElementById('file-name');
        const nextToStep2 = document.getElementById('next-to-step2');
        const backToStep1 = document.getElementById('back-to-step1');
        const generateBtn = document.getElementById('generate-btn');
        const downloadBtn = document.getElementById('download-btn');
        const startOver = document.getElementById('start-over');
        const loading = document.getElementById('loading');
        const loadingText = document.getElementById('loading-text');
        const errorMessage = document.getElementById('error-message');

        // Step navigation
        function showStep(stepNum) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(`step${stepNum}`).classList.add('active');

            document.querySelectorAll('.step').forEach((s, i) => {
                s.classList.remove('active', 'completed');
                if (i + 1 < stepNum) s.classList.add('completed');
                if (i + 1 === stepNum) s.classList.add('active');
            });
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('active');
            setTimeout(() => errorMessage.classList.remove('active'), 5000);
        }

        function showLoading(text) {
            loadingText.textContent = text;
            loading.classList.add('active');
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        }

        function hideLoading() {
            loading.classList.remove('active');
        }

        // File upload handlers
        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) handleFile(files[0]);
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleFile(e.target.files[0]);
        });

        async function handleFile(file) {
            if (!file.name.toLowerCase().endsWith('.pdf')) {
                showError('Please upload a PDF file');
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                showError('File size must be less than 10MB');
                return;
            }

            uploadedFile = file;
            fileName.textContent = file.name;
            fileName.style.display = 'inline-block';
            uploadArea.classList.add('has-file');
            
            // Extract text from PDF
            try {
                showLoading('Extracting text from PDF...');
                extractedText = await extractPdfText(file);
                hideLoading();
                showStep(1);
                nextToStep2.disabled = false;
            } catch (error) {
                hideLoading();
                showStep(1);
                showError('Failed to read PDF. Please try another file.');
                console.error(error);
            }
        }

        async function extractPdfText(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            let text = '';
            
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                const pageText = content.items.map(item => item.str).join(' ');
                text += pageText + '\n';
            }
            
            return text;
        }

        // Navigation
        nextToStep2.addEventListener('click', () => showStep(2));
        backToStep1.addEventListener('click', () => showStep(1));
        startOver.addEventListener('click', () => {
            uploadedFile = null;
            extractedText = '';
            parsedResume = null;
            fileInput.value = '';
            fileName.style.display = 'none';
            uploadArea.classList.remove('has-file');
            nextToStep2.disabled = true;
            document.getElementById('candidate-name').value = '';
            document.getElementById('nationality').value = '';
            document.getElementById('gender').value = '';
            document.getElementById('expected-salary').value = '';
            document.getElementById('notice-period').value = '';
            showStep(1);
        });

        // Generate Resume
        generateBtn.addEventListener('click', async () => {
            const candidateName = document.getElementById('candidate-name').value.trim();
            const nationality = document.getElementById('nationality').value;
            const gender = document.getElementById('gender').value;
            const expectedSalary = document.getElementById('expected-salary').value.trim();
            const noticePeriod = document.getElementById('notice-period').value;

            if (!candidateName || !nationality || !gender || !expectedSalary || !noticePeriod) {
                showError('Please fill in all required fields');
                return;
            }

            showLoading('AI is analyzing the resume...');

            try {
                parsedResume = await parseResumeWithAI(extractedText, {
                    candidateName,
                    nationality,
                    gender,
                    expectedSalary,
                    noticePeriod
                });

                hideLoading();
                displayPreview(parsedResume);
                showStep(3);
            } catch (error) {
                hideLoading();
                showStep(2);
                showError('Failed to process resume. Please try again.');
                console.error(error);
            }
        });

        // Parse resume with Gemini AI
        async function parseResumeWithAI(resumeText, candidateInfo) {
            const API_KEY = 'AIzaSyDHm_f-t_jbpeU_KTeqFbKp0mkTdgUwh9Q';
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`;

            const prompt = `You are a resume parser. Extract and structure the following resume into a JSON format for a recruitment agency template.

CANDIDATE INFO (use these exact values):
- Name: ${candidateInfo.candidateName}
- Nationality: ${candidateInfo.nationality}
- Gender: ${candidateInfo.gender}
- Expected Salary: ${candidateInfo.expectedSalary}
- Notice Period: ${candidateInfo.noticePeriod}

RESUME TEXT:
${resumeText}

Return ONLY valid JSON in this exact format (no markdown, no code blocks, just pure JSON):
{
    "candidateName": "${candidateInfo.candidateName}",
    "nationality": "${candidateInfo.nationality}",
    "gender": "${candidateInfo.gender}",
    "expectedSalary": "${candidateInfo.expectedSalary}",
    "noticePeriod": "${candidateInfo.noticePeriod}",
    "education": [
        {
            "year": "2023",
            "qualification": "Bachelor of Science in Computer Science",
            "institution": "National University of Singapore"
        }
    ],
    "workExperience": [
        {
            "title": "Software Engineer",
            "period": "January 2022 - Present",
            "company": "ABC Company Pte Ltd",
            "responsibilities": [
                "Developed web applications using React and Node.js",
                "Collaborated with cross-functional teams"
            ]
        }
    ],
    "skills": ["JavaScript", "Python", "SQL"],
    "languages": ["English", "Mandarin"]
}

IMPORTANT RULES:
1. Extract ALL work experiences from the resume, maintaining chronological order (most recent first)
2. Extract ALL education entries
3. Each responsibility should be a complete, professional sentence
4. If skills section exists, extract them. If not, infer key skills from work experience
5. Extract languages if mentioned, otherwise default to ["English"]
6. Return ONLY the JSON object, no other text`;

            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.1,
                        maxOutputTokens: 8192,
                    }
                })
            });

            if (!response.ok) {
                throw new Error(`API error: ${response.status}`);
            }

            const data = await response.json();
            const text = data.candidates[0].content.parts[0].text;
            
            // Clean up the response - remove markdown code blocks if present
            let jsonStr = text.trim();
            if (jsonStr.startsWith('```json')) {
                jsonStr = jsonStr.slice(7);
            }
            if (jsonStr.startsWith('```')) {
                jsonStr = jsonStr.slice(3);
            }
            if (jsonStr.endsWith('```')) {
                jsonStr = jsonStr.slice(0, -3);
            }
            jsonStr = jsonStr.trim();

            return JSON.parse(jsonStr);
        }

        // Display preview
        function displayPreview(data) {
            const preview = document.getElementById('preview-content');
            
            let html = `<h3>üìã Candidate Information</h3>
<strong>Name:</strong> ${data.candidateName}<br>
<strong>Nationality:</strong> ${data.nationality}<br>
<strong>Gender:</strong> ${data.gender}<br>
<strong>Expected Salary:</strong> ${data.expectedSalary}<br>
<strong>Notice Period:</strong> ${data.noticePeriod}<br>

<h3>üéì Education</h3>`;
            
            data.education.forEach(edu => {
                html += `<strong>${edu.year}</strong> - ${edu.qualification}<br>`;
                html += `<em>${edu.institution}</em><br><br>`;
            });

            html += `<h3>üíº Work Experience</h3>`;
            data.workExperience.forEach(job => {
                html += `<strong>${job.title}</strong><br>`;
                html += `${job.period}<br>`;
                html += `<em>${job.company}</em><br>`;
                job.responsibilities.forEach(resp => {
                    html += `‚Ä¢ ${resp}<br>`;
                });
                html += `<br>`;
            });

            if (data.skills && data.skills.length > 0) {
                html += `<h3>üõ†Ô∏è Skills</h3>`;
                html += data.skills.join(', ') + '<br>';
            }

            html += `<h3>üåê Languages</h3>`;
            html += data.languages.join(', ');

            preview.innerHTML = html;
        }

        // Download DOCX
        downloadBtn.addEventListener('click', async () => {
            if (!parsedResume) return;

            // Check if docx library is loaded
            if (typeof docx === 'undefined') {
                showError('Document library failed to load. Please refresh the page and try again.');
                return;
            }

            showLoading('Generating Word document...');

            try {
                const doc = createCGPDocument(parsedResume);
                const blob = await docx.Packer.toBlob(doc);
                const safeFileName = parsedResume.candidateName.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '_');
                saveAs(blob, `${safeFileName}_CGP_Format.docx`);
                hideLoading();
                showStep(3);
            } catch (error) {
                hideLoading();
                showStep(3);
                showError('Failed to generate document. Please try again.');
                console.error(error);
            }
        });

        // Create CGP Document
        function createCGPDocument(data) {
            const { Document, Paragraph, TextRun, Table, TableRow, TableCell, AlignmentType, BorderStyle, WidthType, ShadingType, VerticalAlign } = docx;

            // Border styles
            const noBorder = { style: BorderStyle.NIL, size: 0, color: "FFFFFF" };
            const noBorders = { top: noBorder, bottom: noBorder, left: noBorder, right: noBorder };

            // Helper function for bullet points
            function bulletPoint(text) {
                return new Paragraph({
                    bullet: { level: 0 },
                    spacing: { after: 80 },
                    children: [new TextRun({ text: text, size: 22, font: "Calibri" })]
                });
            }

            // Section header with orange/red background
            function sectionHeader(title) {
                return new Table({
                    columnWidths: [9360],
                    rows: [
                        new TableRow({
                            children: [
                                new TableCell({
                                    borders: noBorders,
                                    shading: { fill: "CC3300", type: ShadingType.CLEAR },
                                    width: { size: 9360, type: WidthType.DXA },
                                    children: [new Paragraph({
                                        spacing: { before: 60, after: 60 },
                                        children: [new TextRun({ text: title, bold: true, size: 22, font: "Calibri", color: "FFFFFF" })]
                                    })]
                                })
                            ]
                        })
                    ]
                });
            }

            // Create info row
            function createInfoRow(label, value) {
                return new TableRow({
                    children: [
                        new TableCell({
                            borders: noBorders,
                            width: { size: 2300, type: WidthType.DXA },
                            children: [new Paragraph({
                                children: [new TextRun({ text: label, bold: true, size: 22, font: "Calibri" })]
                            })]
                        }),
                        new TableCell({
                            borders: noBorders,
                            width: { size: 7060, type: WidthType.DXA },
                            children: [new Paragraph({
                                children: [
                                    new TextRun({ text: ": ", bold: true, size: 22, font: "Calibri" }),
                                    new TextRun({ text: value, bold: true, size: 22, font: "Calibri" })
                                ]
                            })]
                        })
                    ]
                });
            }

            // Build document content
            const children = [];

            // Candidate Info Table
            children.push(new Table({
                columnWidths: [2300, 7060],
                rows: [
                    createInfoRow("Candidate Name", data.candidateName),
                    createInfoRow("Nationality", data.nationality),
                    createInfoRow("Gender", data.gender),
                    createInfoRow("Expected Salary", data.expectedSalary),
                    createInfoRow("Notice Period", data.noticePeriod),
                ]
            }));

            // Spacing
            children.push(new Paragraph({ spacing: { before: 200, after: 100 }, children: [] }));

            // Education Section
            children.push(sectionHeader("EDUCATION"));
            data.education.forEach(edu => {
                children.push(new Paragraph({
                    spacing: { before: 120, after: 40 },
                    children: [
                        new TextRun({ text: edu.year + " ", bold: true, size: 22, font: "Calibri" }),
                        new TextRun({ text: edu.qualification, bold: true, size: 22, font: "Calibri" })
                    ]
                }));
                children.push(new Paragraph({
                    indent: { left: 720 },
                    spacing: { after: 80 },
                    children: [new TextRun({ text: edu.institution, bold: true, size: 22, font: "Calibri" })]
                }));
            });

            // Spacing
            children.push(new Paragraph({ spacing: { before: 100 }, children: [] }));

            // Work Experience Section
            children.push(sectionHeader("WORKING EXPERIENCE"));
            data.workExperience.forEach(job => {
                // Job title
                children.push(new Paragraph({
                    spacing: { before: 160, after: 40 },
                    children: [new TextRun({ text: job.title, bold: true, size: 22, font: "Calibri" })]
                }));
                // Period
                children.push(new Paragraph({
                    spacing: { after: 40 },
                    children: [new TextRun({ text: job.period, bold: true, size: 22, font: "Calibri" })]
                }));
                // Company
                children.push(new Paragraph({
                    spacing: { after: 80 },
                    children: [new TextRun({ text: job.company, bold: true, size: 22, font: "Calibri" })]
                }));
                // Responsibilities
                job.responsibilities.forEach(resp => {
                    children.push(bulletPoint(resp));
                });
            });

            // Skills Section (if present)
            if (data.skills && data.skills.length > 0) {
                children.push(new Paragraph({ spacing: { before: 160 }, children: [] }));
                children.push(sectionHeader("SKILLS"));
                data.skills.forEach(skill => {
                    children.push(bulletPoint(skill));
                });
            }

            // Language Section
            children.push(new Paragraph({ spacing: { before: 160 }, children: [] }));
            children.push(sectionHeader("LANGUAGE"));
            data.languages.forEach(lang => {
                children.push(bulletPoint(lang));
            });

            return new Document({
                sections: [{
                    properties: {
                        page: { margin: { top: 1440, right: 1080, bottom: 1080, left: 1080 } }
                    },
                    children: children
                }]
            });
        }
    </script>
</body>
</html>
