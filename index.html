<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CGP Resume Converter</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- Template processing libraries -->
    <script src="https://cdn.jsdelivr.net/npm/pizzip@3.1.4/dist/pizzip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docxtemplater@3.42.0/build/docxtemplater.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #CC3300;
            --primary-dark: #A32900;
            --secondary: #1a1a2e;
            --accent: #E8E8E8;
            --bg: #FAFAFA;
            --card-bg: #FFFFFF;
            --text: #1a1a2e;
            --text-muted: #6B7280;
            --success: #10B981;
            --border: #E5E7EB;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--secondary) 0%, #2d2d4a 100%);
            padding: 1.5rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 45px;
            height: 45px;
            background: var(--primary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            font-size: 1.2rem;
            transform: rotate(-3deg);
        }

        .logo-text {
            color: white;
            font-size: 1.4rem;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .logo-text span {
            color: var(--primary);
        }

        .header-subtitle {
            color: rgba(255,255,255,0.7);
            font-size: 0.85rem;
            font-family: 'Space Mono', monospace;
        }

        /* Main Container */
        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 2.5rem 1.5rem;
        }

        /* Steps Indicator */
        .steps {
            display: flex;
            justify-content: center;
            gap: 0;
            margin-bottom: 2.5rem;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0.75rem 1.5rem;
            background: var(--card-bg);
            border: 2px solid var(--border);
            position: relative;
            transition: all 0.3s ease;
        }

        .step:first-child {
            border-radius: 50px 0 0 50px;
        }

        .step:last-child {
            border-radius: 0 50px 50px 0;
        }

        .step.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .step.completed {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .step-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .step.active .step-number,
        .step.completed .step-number {
            background: rgba(255,255,255,0.25);
        }

        .step-label {
            font-weight: 500;
            font-size: 0.9rem;
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 25px rgba(0,0,0,0.06);
            border: 1px solid var(--border);
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1.25rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #f8f9fa 0%, #fff 100%);
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: linear-gradient(135deg, #fff5f2 0%, #fff 100%);
        }

        .upload-area.drag-over {
            border-color: var(--primary);
            background: #fff5f2;
            transform: scale(1.01);
        }

        .upload-area.has-file {
            border-color: var(--success);
            background: linear-gradient(135deg, #ecfdf5 0%, #fff 100%);
        }

        .upload-icon {
            width: 70px;
            height: 70px;
            margin: 0 auto 1.25rem;
            background: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            transition: all 0.3s ease;
        }

        .upload-area:hover .upload-icon {
            background: var(--primary);
            color: white;
            transform: scale(1.05);
        }

        .upload-area.has-file .upload-icon {
            background: var(--success);
            color: white;
        }

        .upload-text {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .upload-subtext {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .file-name {
            margin-top: 1rem;
            padding: 0.75rem 1.25rem;
            background: var(--accent);
            border-radius: 8px;
            font-family: 'Space Mono', monospace;
            font-size: 0.85rem;
            display: inline-block;
        }

        /* Form Grid */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.25rem;
        }

        @media (max-width: 600px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text);
        }

        input, select {
            padding: 0.85rem 1rem;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            font-family: 'DM Sans', sans-serif;
            transition: all 0.2s ease;
            background: white;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(204, 51, 0, 0.1);
        }

        /* Buttons */
        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            font-family: 'DM Sans', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(204, 51, 0, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(204, 51, 0, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--accent);
            color: var(--text);
        }

        .btn-secondary:hover {
            background: #d1d5db;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(16, 185, 129, 0.4);
        }

        .actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        /* Loading */
        .loading {
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 3rem;
        }

        .loading.active {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--accent);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 1.25rem;
            font-weight: 500;
            color: var(--text-muted);
        }

        /* Preview Section */
        .preview-section {
            display: none;
        }

        .preview-section.active {
            display: block;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .preview-content {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1.5rem;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'Space Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.8;
            border: 1px solid var(--border);
        }

        .preview-content h3 {
            color: var(--primary);
            margin: 1rem 0 0.5rem;
            font-family: 'DM Sans', sans-serif;
        }

        .preview-content h3:first-child {
            margin-top: 0;
        }

        /* Success Message */
        .success-message {
            display: none;
            text-align: center;
            padding: 3rem;
        }

        .success-message.active {
            display: block;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 2.5rem;
            color: white;
            animation: pop 0.5s ease;
        }

        @keyframes pop {
            0% { transform: scale(0); }
            70% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .success-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .success-subtitle {
            color: var(--text-muted);
            margin-bottom: 2rem;
        }

        /* Error */
        .error-message {
            background: #FEE2E2;
            border: 1px solid #FECACA;
            color: #DC2626;
            padding: 1rem 1.25rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            display: none;
        }

        .error-message.active {
            display: block;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        /* Hide sections */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Template Management */
        .template-section {
            background: var(--card-bg);
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .template-section.has-template {
            border-color: var(--success);
            border-style: solid;
        }

        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .template-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .template-status {
            font-size: 0.85rem;
            padding: 4px 12px;
            border-radius: 20px;
            background: var(--accent);
            color: var(--text-muted);
        }

        .template-status.active {
            background: #D1FAE5;
            color: #065F46;
        }

        .template-info {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        .template-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }

        .btn-danger {
            background: #FEE2E2;
            color: #DC2626;
            border: none;
        }

        .btn-danger:hover {
            background: #FECACA;
        }

        .template-filename {
            font-family: 'Space Mono', monospace;
            font-size: 0.85rem;
            background: var(--accent);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            margin-top: 0.75rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .template-filename .remove-btn {
            cursor: pointer;
            color: var(--text-muted);
            font-size: 1.1rem;
            line-height: 1;
        }

        .template-filename .remove-btn:hover {
            color: #DC2626;
        }

        .collapsible-header {
            cursor: pointer;
            user-select: none;
        }

        .collapsible-header::after {
            content: '‚ñº';
            font-size: 0.75rem;
            margin-left: 8px;
            transition: transform 0.3s ease;
        }

        .collapsible-header.collapsed::after {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.collapsed {
            max-height: 0;
            margin: 0;
            padding: 0;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .steps {
                flex-direction: column;
                align-items: center;
            }

            .step {
                width: 100%;
                max-width: 280px;
                border-radius: 10px !important;
                justify-content: center;
            }

            .container {
                padding: 1.5rem 1rem;
            }

            .actions {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <div class="logo-icon">CGP</div>
            <div>
                <div class="logo-text">Resume <span>Converter</span></div>
                <div class="header-subtitle">Powered by AI</div>
            </div>
        </div>
    </header>

    <main class="container">
        <!-- Steps Indicator -->
        <div class="steps">
            <div class="step active" id="step1-indicator">
                <div class="step-number">1</div>
                <div class="step-label">Upload Resume</div>
            </div>
            <div class="step" id="step2-indicator">
                <div class="step-number">2</div>
                <div class="step-label">Enter Details</div>
            </div>
            <div class="step" id="step3-indicator">
                <div class="step-number">3</div>
                <div class="step-label">Download</div>
            </div>
        </div>

        <!-- Error Message -->
        <div class="error-message" id="error-message"></div>

        <!-- Template Management Section -->
        <div class="template-section" id="template-section">
            <div class="template-header">
                <div class="template-title collapsible-header" id="template-toggle">
                    üìã CGP Template
                </div>
                <div class="template-status" id="template-status">No Template</div>
            </div>
            <div class="collapsible-content" id="template-content">
                <div class="template-info">
                    Upload a Word document (.docx) template with proper header and footer formatting.
                    Use placeholders in your template:<br>
                    <code>{candidateName}</code>, <code>{nationality}</code>, <code>{gender}</code>, <code>{expectedSalary}</code>, <code>{noticePeriod}</code><br>
                    <code>{#education}{year} {qualification} - {institution}{/education}</code><br>
                    <code>{#workExperience}{title} | {period} | {company}{#responsibilities}{.}{/responsibilities}{/workExperience}</code><br>
                    <code>{#skills}{.}{/skills}</code>, <code>{#languages}{.}{/languages}</code>
                </div>
                <div class="template-actions">
                    <button class="btn btn-outline btn-small" id="upload-template-btn">
                        üì§ Upload Template
                    </button>
                    <button class="btn btn-small btn-secondary" id="download-sample-btn">
                        üì• Download Sample Template
                    </button>
                </div>
                <input type="file" id="template-input" accept=".docx" style="display: none;">
                <div class="template-filename" id="template-filename" style="display: none;">
                    <span id="template-name-text"></span>
                    <span class="remove-btn" id="remove-template" title="Remove template">√ó</span>
                </div>
            </div>
        </div>

        <!-- Step 1: Upload -->
        <section class="section active" id="step1">
            <div class="card">
                <div class="card-title">
                    <div class="card-title-icon">üìÑ</div>
                    Upload Candidate Resume
                </div>
                <div class="upload-area" id="upload-area">
                    <div class="upload-icon">üìÅ</div>
                    <div class="upload-text">Drop your resume here or click to browse</div>
                    <div class="upload-subtext">Supports PDF files (Max 10MB)</div>
                    <div class="file-name" id="file-name" style="display: none;"></div>
                </div>
                <input type="file" id="file-input" accept=".pdf" style="display: none;">
            </div>

            <div class="actions">
                <button class="btn btn-primary" id="next-to-step2" disabled>
                    Continue to Details ‚Üí
                </button>
            </div>
        </section>

        <!-- Step 2: Candidate Details -->
        <section class="section" id="step2">
            <div class="card">
                <div class="card-title">
                    <div class="card-title-icon">üë§</div>
                    Candidate Details
                </div>
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="candidate-name">Candidate Name *</label>
                        <input type="text" id="candidate-name" placeholder="e.g. John Tan Wei Ming" required>
                    </div>
                    <div class="form-group">
                        <label for="nationality">Nationality *</label>
                        <select id="nationality" required>
                            <option value="">Select nationality</option>
                            <option value="Singaporean">Singaporean</option>
                            <option value="Singapore PR">Singapore PR</option>
                            <option value="Malaysian">Malaysian</option>
                            <option value="Chinese">Chinese</option>
                            <option value="Indian">Indian</option>
                            <option value="Filipino">Filipino</option>
                            <option value="Indonesian">Indonesian</option>
                            <option value="Vietnamese">Vietnamese</option>
                            <option value="Thai">Thai</option>
                            <option value="Myanmar">Myanmar</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="gender">Gender *</label>
                        <select id="gender" required>
                            <option value="">Select gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="expected-salary">Expected Salary (SGD) *</label>
                        <input type="text" id="expected-salary" placeholder="e.g. 4,000 or 4,000 - 5,000">
                    </div>
                    <div class="form-group">
                        <label for="notice-period">Notice Period *</label>
                        <select id="notice-period" required>
                            <option value="">Select notice period</option>
                            <option value="Immediate">Immediate</option>
                            <option value="1 Week">1 Week</option>
                            <option value="2 Weeks">2 Weeks</option>
                            <option value="1 Month">1 Month</option>
                            <option value="2 Months">2 Months</option>
                            <option value="3 Months">3 Months</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="actions">
                <button class="btn btn-secondary" id="back-to-step1">‚Üê Back</button>
                <button class="btn btn-primary" id="generate-btn">
                    üöÄ Generate CGP Resume
                </button>
            </div>
        </section>

        <!-- Loading -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div class="loading-text" id="loading-text">Processing resume with AI...</div>
        </div>

        <!-- Step 3: Preview & Download -->
        <section class="section" id="step3">
            <div class="success-message active">
                <div class="success-icon">‚úì</div>
                <div class="success-title">Resume Converted Successfully!</div>
                <div class="success-subtitle">Your CGP-formatted resume is ready to download</div>
            </div>

            <div class="card preview-section active">
                <div class="preview-header">
                    <div class="card-title" style="margin-bottom: 0;">
                        <div class="card-title-icon">üëÅÔ∏è</div>
                        Preview
                    </div>
                </div>
                <div class="preview-content" id="preview-content">
                    <!-- Preview will be inserted here -->
                </div>
            </div>

            <div class="actions">
                <button class="btn btn-secondary" id="start-over">‚Üê Convert Another</button>
                <button class="btn btn-success" id="download-btn">
                    üì• Download .docx
                </button>
            </div>
        </section>
    </main>

    <footer class="footer">
        <p>CGP Resume Converter ‚Ä¢ Cornerstone Global Partners Pte Ltd</p>
    </footer>

    <script>
        // PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // CGP Logo as base64
        const CGP_LOGO_BASE64 = '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';

        // State
        let uploadedFile = null;
        let extractedText = '';
        let parsedResume = null;
        let templateData = null;  // Stores the uploaded template as ArrayBuffer
        let templateName = null;  // Stores the template filename

        // DOM Elements
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const fileName = document.getElementById('file-name');
        const nextToStep2 = document.getElementById('next-to-step2');
        const backToStep1 = document.getElementById('back-to-step1');
        const generateBtn = document.getElementById('generate-btn');
        const downloadBtn = document.getElementById('download-btn');
        const startOver = document.getElementById('start-over');
        const loading = document.getElementById('loading');
        const loadingText = document.getElementById('loading-text');
        const errorMessage = document.getElementById('error-message');

        // Step navigation
        function showStep(stepNum) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(`step${stepNum}`).classList.add('active');

            document.querySelectorAll('.step').forEach((s, i) => {
                s.classList.remove('active', 'completed');
                if (i + 1 < stepNum) s.classList.add('completed');
                if (i + 1 === stepNum) s.classList.add('active');
            });
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('active');
            setTimeout(() => errorMessage.classList.remove('active'), 5000);
        }

        function showLoading(text) {
            loadingText.textContent = text;
            loading.classList.add('active');
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        }

        function hideLoading() {
            loading.classList.remove('active');
        }

        // Template Management
        const templateSection = document.getElementById('template-section');
        const templateStatus = document.getElementById('template-status');
        const templateToggle = document.getElementById('template-toggle');
        const templateContent = document.getElementById('template-content');
        const uploadTemplateBtn = document.getElementById('upload-template-btn');
        const downloadSampleBtn = document.getElementById('download-sample-btn');
        const templateInput = document.getElementById('template-input');
        const templateFilename = document.getElementById('template-filename');
        const templateNameText = document.getElementById('template-name-text');
        const removeTemplate = document.getElementById('remove-template');

        // Initialize template from localStorage
        function initTemplate() {
            const savedTemplate = localStorage.getItem('cgpTemplate');
            const savedTemplateName = localStorage.getItem('cgpTemplateName');
            if (savedTemplate && savedTemplateName) {
                // Convert base64 back to ArrayBuffer
                const binaryString = atob(savedTemplate);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                templateData = bytes.buffer;
                templateName = savedTemplateName;
                updateTemplateUI(true);
            }
        }

        function updateTemplateUI(hasTemplate) {
            if (hasTemplate) {
                templateSection.classList.add('has-template');
                templateStatus.textContent = 'Template Loaded';
                templateStatus.classList.add('active');
                templateFilename.style.display = 'inline-flex';
                templateNameText.textContent = templateName;
            } else {
                templateSection.classList.remove('has-template');
                templateStatus.textContent = 'No Template';
                templateStatus.classList.remove('active');
                templateFilename.style.display = 'none';
                templateNameText.textContent = '';
            }
        }

        // Collapsible toggle
        templateToggle.addEventListener('click', () => {
            templateToggle.classList.toggle('collapsed');
            templateContent.classList.toggle('collapsed');
        });

        // Upload template
        uploadTemplateBtn.addEventListener('click', () => templateInput.click());

        templateInput.addEventListener('change', async (e) => {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                if (!file.name.toLowerCase().endsWith('.docx')) {
                    showError('Please upload a .docx file');
                    return;
                }
                try {
                    templateData = await file.arrayBuffer();
                    templateName = file.name;

                    // Save to localStorage as base64
                    const bytes = new Uint8Array(templateData);
                    let binary = '';
                    for (let i = 0; i < bytes.length; i++) {
                        binary += String.fromCharCode(bytes[i]);
                    }
                    localStorage.setItem('cgpTemplate', btoa(binary));
                    localStorage.setItem('cgpTemplateName', templateName);

                    updateTemplateUI(true);
                } catch (error) {
                    showError('Failed to load template file');
                    console.error(error);
                }
            }
        });

        // Remove template
        removeTemplate.addEventListener('click', () => {
            templateData = null;
            templateName = null;
            localStorage.removeItem('cgpTemplate');
            localStorage.removeItem('cgpTemplateName');
            templateInput.value = '';
            updateTemplateUI(false);
        });

        // Download sample template
        downloadSampleBtn.addEventListener('click', async () => {
            showLoading('Generating sample template...');
            try {
                const blob = await createSampleTemplate();
                saveAs(blob, 'CGP_Template_Sample.docx');
                hideLoading();
            } catch (error) {
                hideLoading();
                showError('Failed to create sample template');
                console.error(error);
            }
        });

        // Create a sample template with placeholders
        async function createSampleTemplate() {
            // Fetch a minimal docx template and modify it with docxtemplater placeholders
            // For now, we'll create a simple template using the existing structure
            const content = `
                <w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
                    <w:body>
                        <w:p><w:r><w:t>Candidate Name: {candidateName}</w:t></w:r></w:p>
                        <w:p><w:r><w:t>Nationality: {nationality}</w:t></w:r></w:p>
                        <w:p><w:r><w:t>Gender: {gender}</w:t></w:r></w:p>
                        <w:p><w:r><w:t>Expected Salary: {expectedSalary}</w:t></w:r></w:p>
                        <w:p><w:r><w:t>Notice Period: {noticePeriod}</w:t></w:r></w:p>
                        <w:p><w:r><w:t></w:t></w:r></w:p>
                        <w:p><w:r><w:t>EDUCATION</w:t></w:r></w:p>
                        <w:p><w:r><w:t>{#education}{year} - {qualification}</w:t></w:r></w:p>
                        <w:p><w:r><w:t>{institution}{/education}</w:t></w:r></w:p>
                        <w:p><w:r><w:t></w:t></w:r></w:p>
                        <w:p><w:r><w:t>WORKING EXPERIENCE</w:t></w:r></w:p>
                        <w:p><w:r><w:t>{#workExperience}{title}</w:t></w:r></w:p>
                        <w:p><w:r><w:t>{period}</w:t></w:r></w:p>
                        <w:p><w:r><w:t>{company}</w:t></w:r></w:p>
                        <w:p><w:r><w:t>{#responsibilities}‚Ä¢ {.}</w:t></w:r></w:p>
                        <w:p><w:r><w:t>{/responsibilities}{/workExperience}</w:t></w:r></w:p>
                        <w:p><w:r><w:t></w:t></w:r></w:p>
                        <w:p><w:r><w:t>SKILLS</w:t></w:r></w:p>
                        <w:p><w:r><w:t>{#skills}‚Ä¢ {.}{/skills}</w:t></w:r></w:p>
                        <w:p><w:r><w:t></w:t></w:r></w:p>
                        <w:p><w:r><w:t>LANGUAGES</w:t></w:r></w:p>
                        <w:p><w:r><w:t>{#languages}‚Ä¢ {.}{/languages}</w:t></w:r></w:p>
                    </w:body>
                </w:document>
            `;

            // Create a minimal DOCX file structure
            const zip = new PizZip();

            // Add required files for a valid DOCX
            zip.file('[Content_Types].xml', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
    <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
    <Default Extension="xml" ContentType="application/xml"/>
    <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
    <Override PartName="/word/header1.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.header+xml"/>
    <Override PartName="/word/footer1.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.footer+xml"/>
</Types>`);

            zip.file('_rels/.rels', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
    <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
</Relationships>`);

            zip.file('word/_rels/document.xml.rels', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
    <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/header" Target="header1.xml"/>
    <Relationship Id="rId2" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/footer" Target="footer1.xml"/>
</Relationships>`);

            // Main document with placeholders
            zip.file('word/document.xml', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">
    <w:body>
        <w:p><w:pPr><w:pStyle w:val="Heading1"/></w:pPr><w:r><w:t>Candidate Name: {candidateName}</w:t></w:r></w:p>
        <w:p><w:r><w:t>Nationality: {nationality}</w:t></w:r></w:p>
        <w:p><w:r><w:t>Gender: {gender}</w:t></w:r></w:p>
        <w:p><w:r><w:t>Expected Salary: {expectedSalary}</w:t></w:r></w:p>
        <w:p><w:r><w:t>Notice Period: {noticePeriod}</w:t></w:r></w:p>
        <w:p><w:r><w:t></w:t></w:r></w:p>
        <w:p><w:pPr><w:shd w:val="clear" w:fill="CC3300"/></w:pPr><w:r><w:rPr><w:b/><w:color w:val="FFFFFF"/></w:rPr><w:t>EDUCATION</w:t></w:r></w:p>
        <w:p><w:r><w:t>{#education}{year} - {qualification}</w:t></w:r></w:p>
        <w:p><w:r><w:t>{institution}</w:t></w:r></w:p>
        <w:p><w:r><w:t>{/education}</w:t></w:r></w:p>
        <w:p><w:r><w:t></w:t></w:r></w:p>
        <w:p><w:pPr><w:shd w:val="clear" w:fill="CC3300"/></w:pPr><w:r><w:rPr><w:b/><w:color w:val="FFFFFF"/></w:rPr><w:t>WORKING EXPERIENCE</w:t></w:r></w:p>
        <w:p><w:r><w:t>{#workExperience}</w:t></w:r></w:p>
        <w:p><w:r><w:rPr><w:b/></w:rPr><w:t>{title}</w:t></w:r></w:p>
        <w:p><w:r><w:t>{period}</w:t></w:r></w:p>
        <w:p><w:r><w:t>{company}</w:t></w:r></w:p>
        <w:p><w:r><w:t>{#responsibilities}</w:t></w:r></w:p>
        <w:p><w:pPr><w:numPr><w:ilvl w:val="0"/><w:numId w:val="1"/></w:numPr></w:pPr><w:r><w:t>{.}</w:t></w:r></w:p>
        <w:p><w:r><w:t>{/responsibilities}</w:t></w:r></w:p>
        <w:p><w:r><w:t>{/workExperience}</w:t></w:r></w:p>
        <w:p><w:r><w:t></w:t></w:r></w:p>
        <w:p><w:pPr><w:shd w:val="clear" w:fill="CC3300"/></w:pPr><w:r><w:rPr><w:b/><w:color w:val="FFFFFF"/></w:rPr><w:t>SKILLS</w:t></w:r></w:p>
        <w:p><w:r><w:t>{#skills}</w:t></w:r></w:p>
        <w:p><w:pPr><w:numPr><w:ilvl w:val="0"/><w:numId w:val="1"/></w:numPr></w:pPr><w:r><w:t>{.}</w:t></w:r></w:p>
        <w:p><w:r><w:t>{/skills}</w:t></w:r></w:p>
        <w:p><w:r><w:t></w:t></w:r></w:p>
        <w:p><w:pPr><w:shd w:val="clear" w:fill="CC3300"/></w:pPr><w:r><w:rPr><w:b/><w:color w:val="FFFFFF"/></w:rPr><w:t>LANGUAGES</w:t></w:r></w:p>
        <w:p><w:r><w:t>{#languages}</w:t></w:r></w:p>
        <w:p><w:pPr><w:numPr><w:ilvl w:val="0"/><w:numId w:val="1"/></w:numPr></w:pPr><w:r><w:t>{.}</w:t></w:r></w:p>
        <w:p><w:r><w:t>{/languages}</w:t></w:r></w:p>
        <w:sectPr>
            <w:headerReference w:type="default" r:id="rId1"/>
            <w:footerReference w:type="default" r:id="rId2"/>
            <w:pgSz w:w="12240" w:h="15840"/>
            <w:pgMar w:top="2016" w:right="1008" w:bottom="1008" w:left="1008" w:header="720" w:footer="720"/>
        </w:sectPr>
    </w:body>
</w:document>`);

            // Header with CGP branding placeholder
            zip.file('word/header1.xml', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:hdr xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
    <w:p>
        <w:pPr><w:jc w:val="right"/></w:pPr>
        <w:r><w:rPr><w:b/><w:color w:val="CC3300"/></w:rPr><w:t>Cornerstone Global Partners Pte Ltd</w:t></w:r>
    </w:p>
    <w:p>
        <w:pPr><w:jc w:val="right"/></w:pPr>
        <w:r><w:rPr><w:color w:val="CC3300"/><w:sz w:val="18"/></w:rPr><w:t>Prepared by: </w:t></w:r>
        <w:r><w:rPr><w:sz w:val="18"/></w:rPr><w:t>Go Ai Wei</w:t></w:r>
    </w:p>
    <w:p>
        <w:pPr><w:jc w:val="right"/></w:pPr>
        <w:r><w:rPr><w:color w:val="CC3300"/><w:sz w:val="18"/></w:rPr><w:t>EA Licence: </w:t></w:r>
        <w:r><w:rPr><w:sz w:val="18"/></w:rPr><w:t>19C9859</w:t></w:r>
    </w:p>
</w:hdr>`);

            // Footer
            zip.file('word/footer1.xml', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:ftr xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
    <w:p>
        <w:pPr><w:jc w:val="center"/></w:pPr>
        <w:r><w:rPr><w:color w:val="808080"/><w:sz w:val="18"/></w:rPr><w:t>‰∏äÊµ∑‰ªïÈöÜ‰∫∫ÂäõË≥áÊ∫êÊúâÈôêÂÖ¨Âè∏ | www.cgpo2o.com</w:t></w:r>
    </w:p>
</w:ftr>`);

            return zip.generate({ type: 'blob', mimeType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });
        }

        // Initialize template on page load
        initTemplate();

        // File upload handlers
        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) handleFile(files[0]);
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleFile(e.target.files[0]);
        });

        async function handleFile(file) {
            if (!file.name.toLowerCase().endsWith('.pdf')) {
                showError('Please upload a PDF file');
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                showError('File size must be less than 10MB');
                return;
            }

            uploadedFile = file;
            fileName.textContent = file.name;
            fileName.style.display = 'inline-block';
            uploadArea.classList.add('has-file');
            
            // Extract text from PDF
            try {
                showLoading('Extracting text from PDF...');
                extractedText = await extractPdfText(file);
                hideLoading();
                showStep(1);
                nextToStep2.disabled = false;
            } catch (error) {
                hideLoading();
                showStep(1);
                showError('Failed to read PDF. Please try another file.');
                console.error(error);
            }
        }

        async function extractPdfText(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            let text = '';
            
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                const pageText = content.items.map(item => item.str).join(' ');
                text += pageText + '\n';
            }
            
            return text;
        }

        // Navigation
        nextToStep2.addEventListener('click', () => showStep(2));
        backToStep1.addEventListener('click', () => showStep(1));
        startOver.addEventListener('click', () => {
            uploadedFile = null;
            extractedText = '';
            parsedResume = null;
            fileInput.value = '';
            fileName.style.display = 'none';
            uploadArea.classList.remove('has-file');
            nextToStep2.disabled = true;
            document.getElementById('candidate-name').value = '';
            document.getElementById('nationality').value = '';
            document.getElementById('gender').value = '';
            document.getElementById('expected-salary').value = '';
            document.getElementById('notice-period').value = '';
            showStep(1);
        });

        // Generate Resume
        generateBtn.addEventListener('click', async () => {
            const candidateName = document.getElementById('candidate-name').value.trim();
            const nationality = document.getElementById('nationality').value;
            const gender = document.getElementById('gender').value;
            const expectedSalary = document.getElementById('expected-salary').value.trim();
            const noticePeriod = document.getElementById('notice-period').value;

            if (!candidateName || !nationality || !gender || !expectedSalary || !noticePeriod) {
                showError('Please fill in all required fields');
                return;
            }

            showLoading('AI is analyzing the resume...');

            try {
                parsedResume = await parseResumeWithAI(extractedText, {
                    candidateName,
                    nationality,
                    gender,
                    expectedSalary,
                    noticePeriod
                });

                hideLoading();
                displayPreview(parsedResume);
                showStep(3);
            } catch (error) {
                hideLoading();
                showStep(2);
                showError('Failed to process resume. Please try again.');
                console.error(error);
            }
        });

        // Parse resume with Gemini AI
        async function parseResumeWithAI(resumeText, candidateInfo) {
            const API_KEY = 'AIzaSyDHm_f-t_jbpeU_KTeqFbKp0mkTdgUwh9Q';
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`;

            const prompt = `You are a resume parser. Extract and structure the following resume into a JSON format for a recruitment agency template.

CANDIDATE INFO (use these exact values):
- Name: ${candidateInfo.candidateName}
- Nationality: ${candidateInfo.nationality}
- Gender: ${candidateInfo.gender}
- Expected Salary: ${candidateInfo.expectedSalary}
- Notice Period: ${candidateInfo.noticePeriod}

RESUME TEXT:
${resumeText}

Return ONLY valid JSON in this exact format (no markdown, no code blocks, just pure JSON):
{
    "candidateName": "${candidateInfo.candidateName}",
    "nationality": "${candidateInfo.nationality}",
    "gender": "${candidateInfo.gender}",
    "expectedSalary": "${candidateInfo.expectedSalary}",
    "noticePeriod": "${candidateInfo.noticePeriod}",
    "education": [
        {
            "year": "2023",
            "qualification": "Bachelor of Science in Computer Science",
            "institution": "National University of Singapore"
        }
    ],
    "workExperience": [
        {
            "title": "Software Engineer",
            "period": "January 2022 - Present",
            "company": "ABC Company Pte Ltd",
            "responsibilities": [
                "Developed web applications using React and Node.js",
                "Collaborated with cross-functional teams"
            ]
        }
    ],
    "skills": ["JavaScript", "Python", "SQL"],
    "languages": ["English", "Mandarin"]
}

IMPORTANT RULES:
1. Extract ALL work experiences from the resume, maintaining chronological order (most recent first)
2. Extract ALL education entries
3. Each responsibility should be a complete, professional sentence
4. If skills section exists, extract them. If not, infer key skills from work experience
5. Extract languages if mentioned, otherwise default to ["English"]
6. Return ONLY the JSON object, no other text`;

            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.1,
                        maxOutputTokens: 8192,
                    }
                })
            });

            if (!response.ok) {
                throw new Error(`API error: ${response.status}`);
            }

            const data = await response.json();
            const text = data.candidates[0].content.parts[0].text;

            // Clean up the response - remove markdown code blocks if present
            let jsonStr = text.trim();
            if (jsonStr.startsWith('```json')) {
                jsonStr = jsonStr.slice(7);
            }
            if (jsonStr.startsWith('```')) {
                jsonStr = jsonStr.slice(3);
            }
            if (jsonStr.endsWith('```')) {
                jsonStr = jsonStr.slice(0, -3);
            }
            jsonStr = jsonStr.trim();

            // Fix common JSON issues from AI responses
            // Replace unescaped newlines inside strings with escaped newlines
            jsonStr = fixJsonString(jsonStr);

            try {
                return JSON.parse(jsonStr);
            } catch (parseError) {
                console.error('JSON Parse Error:', parseError);
                console.error('Raw JSON string:', jsonStr);
                throw new Error('Failed to parse AI response as JSON');
            }
        }

        // Function to fix common JSON issues from AI responses
        function fixJsonString(str) {
            // This function fixes unescaped characters inside JSON string values
            let result = '';
            let inString = false;
            let i = 0;

            while (i < str.length) {
                const char = str[i];
                const nextChar = str[i + 1];

                if (char === '"' && (i === 0 || str[i - 1] !== '\\')) {
                    inString = !inString;
                    result += char;
                } else if (inString) {
                    // Inside a string, escape problematic characters
                    if (char === '\n') {
                        result += '\\n';
                    } else if (char === '\r') {
                        result += '\\r';
                    } else if (char === '\t') {
                        result += '\\t';
                    } else {
                        result += char;
                    }
                } else {
                    result += char;
                }
                i++;
            }

            return result;
        }

        // Display preview
        function displayPreview(data) {
            const preview = document.getElementById('preview-content');
            
            let html = `<h3>üìã Candidate Information</h3>
<strong>Name:</strong> ${data.candidateName}<br>
<strong>Nationality:</strong> ${data.nationality}<br>
<strong>Gender:</strong> ${data.gender}<br>
<strong>Expected Salary:</strong> ${data.expectedSalary}<br>
<strong>Notice Period:</strong> ${data.noticePeriod}<br>

<h3>üéì Education</h3>`;
            
            data.education.forEach(edu => {
                html += `<strong>${edu.year}</strong> - ${edu.qualification}<br>`;
                html += `<em>${edu.institution}</em><br><br>`;
            });

            html += `<h3>üíº Work Experience</h3>`;
            data.workExperience.forEach(job => {
                html += `<strong>${job.title}</strong><br>`;
                html += `${job.period}<br>`;
                html += `<em>${job.company}</em><br>`;
                job.responsibilities.forEach(resp => {
                    html += `‚Ä¢ ${resp}<br>`;
                });
                html += `<br>`;
            });

            if (data.skills && data.skills.length > 0) {
                html += `<h3>üõ†Ô∏è Skills</h3>`;
                html += data.skills.join(', ') + '<br>';
            }

            html += `<h3>üåê Languages</h3>`;
            html += data.languages.join(', ');

            preview.innerHTML = html;
        }

        // Download DOCX
        downloadBtn.addEventListener('click', async () => {
            if (!parsedResume) return;

            // Check if template is loaded
            if (!templateData) {
                showError('Please upload a CGP template first. Click "Download Sample Template" to get started.');
                return;
            }

            showLoading('Generating Word document...');

            try {
                const blob = await generateFromTemplate(parsedResume);
                const safeFileName = parsedResume.candidateName.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '_');
                saveAs(blob, `${safeFileName}_CGP_Format.docx`);
                hideLoading();
                showStep(3);
            } catch (error) {
                hideLoading();
                showStep(3);
                showError('Failed to generate document. Check your template has correct placeholders.');
                console.error(error);
            }
        });

        // Generate document from template using docxtemplater
        async function generateFromTemplate(data) {
            // Load the template
            const zip = new PizZip(templateData);

            // Create docxtemplater instance
            const doc = new window.docxtemplater(zip, {
                paragraphLoop: true,
                linebreaks: true,
                delimiters: {
                    start: '{',
                    end: '}'
                }
            });

            // Set the template data
            doc.setData({
                candidateName: data.candidateName || '',
                nationality: data.nationality || '',
                gender: data.gender || '',
                expectedSalary: data.expectedSalary || '',
                noticePeriod: data.noticePeriod || '',
                education: data.education || [],
                workExperience: data.workExperience || [],
                skills: data.skills || [],
                languages: data.languages || []
            });

            // Render the document
            doc.render();

            // Generate output
            const output = doc.getZip().generate({
                type: 'blob',
                mimeType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
            });

            return output;
        }
    </script>
</body>
</html>
